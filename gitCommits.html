<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My GitLab Commits</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #ddd;
        }
        .loading {
            display: none;
            margin: 20px 0;
            font-weight: bold;
            color: #666;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>My GitLab Commits</h1>

    <div>
        <label for="date">Select Date:</label>
        <input type="date" id="date">
        <input type="text" id="token" placeholder="Your GitLab Access Token">
        <button onclick="getAllCommits()">Get My Commits</button>
    </div>

    <div id="loading" class="loading">Loading commits...</div>

    <table id="commits-table">
        <thead>
        <tr>
            <th>Project</th>
            <th>Commit Message</th>
            <th>Commit Hash</th>
            <th>Date</th>
            <th>Branch</th>
        </tr>
        </thead>
        <tbody id="commits-body"></tbody>
    </table>
</div>
<div style="margin-top: 20px;">
    <p>Commit Summary:</p>
    <textarea id="commit-summary" rows="10" style="width: 100%; padding: 10px;" readonly></textarea>
    <button onclick="copyToClipboard()" style="margin-top: 10px; padding: 5px 15px;">复制提交信息内容</button>
</div>


<script>
    async function getAllCommits() {
        const date = document.getElementById('date').value;
        const token = document.getElementById('token').value;
        const tbody = document.getElementById('commits-body');
        const loading = document.getElementById('loading');

        if (!date || !token) {
            alert('Please select a date and enter your GitLab token');
            return;
        }

        const baseUrl = 'http://172.18.159.10/api/v4';
        const since = `${date}T00:00:00Z`;
        const until = `${date}T23:59:59Z`;

        try {
            loading.style.display = 'block';
            tbody.innerHTML = '';

            // 1. 获取当前用户信息
            const userResponse = await fetch(`${baseUrl}/user`, {
                headers: { 'PRIVATE-TOKEN': token }
            });
            const userData = await userResponse.json();
            const userId = userData.id;

            // 2. 获取所有项目
            const projects = [];
            let page = 1;
            while (true) {
                const projectsResponse = await fetch(
                    `${baseUrl}/projects?membership=true&page=${page}&per_page=100`,
                    {
                        headers: { 'PRIVATE-TOKEN': token }
                    }
                );
                const projectsData = await projectsResponse.json();
                if (projectsData.length === 0) break;
                projects.push(...projectsData);
                page++;
            }

            // 3. 遍历所有项目获取提交记录
            for (const project of projects) {
                const commitsResponse = await fetch(
                    `${baseUrl}/projects/${project.id}/repository/commits?since=${since}&until=${until}&all=true`,
                    {
                        headers: { 'PRIVATE-TOKEN': token }
                    }
                );
                const commits = await commitsResponse.json();

                // 4. 筛选出自己的提交
                const myCommits = commits.filter(commit =>
                    commit.author_email === userData.email ||
                    commit.author_name === userData.name
                );

                // 5. 添加到表格中
                for (const commit of myCommits) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                            <td>${project.name}</td>
                            <td>${commit.message}</td>
                            <td><a href="${project.web_url}/-/commit/${commit.id}" target="_blank">${commit.short_id}</a></td>
                            <td>${new Date(commit.created_at).toLocaleString()}</td>
                            <td>${commit.refs ? commit.refs.map(ref => ref.name).join(', ') : ''}</td>
                        `;
                    tbody.appendChild(row);
                }
            }

            loading.style.display = 'none';
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No commits found for this date.</td></tr>';
            }

        } catch (error) {
            loading.style.display = 'none';
            tbody.innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`;
        }

        // 在getAllCommits函数中，在处理完所有提交后添加这段代码
// (在 loading.style.display = 'none'; 之前)
        const projectCommits = {};

// 按项目分组收集提交信息
        tbody.querySelectorAll('tr').forEach((row) => {
            const project = row.cells[0].textContent.trim();
            const message = row.cells[1].textContent.trim();

            if (!projectCommits[project]) {
                projectCommits[project] = [];
            }
            projectCommits[project].push(message);
        });

        // 格式化输出
        const formattedMessages = [];
        for (const project in projectCommits) {
            formattedMessages.push(`${project}:`);
            projectCommits[project].forEach((message, index) => {
                formattedMessages.push(`    ${index + 1}. ${message}`);
            });
            formattedMessages.push(''); // 添加空行分隔不同项目
        }

        document.getElementById('commit-summary').value = formattedMessages.join('\n');
    }

    // 复制功能
    function copyToClipboard() {
        const textarea = document.getElementById('commit-summary');
        textarea.select();
        document.execCommand('copy');
        alert('内容已复制到剪贴板！');
    }



</script>

</body>
</html>
